# 第五章 输入输出管理

## 5.1 I/O管理概述

### 1. I/O设备的基本概念

- 基本概念![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\849de716bd9295c14ab9f4efe063e031578bc2a2f7f63b1072f2c26dac364aab.png)
- I/O就是“输入/输出”，将数据输入到计算机（出和入的参考系），或接收计算机的数据输出到外部设备
	
- 参照系：“出” 和“入”的参照系是计算机，或者CPU
- 分类

	- 按传输速率分类

		- 低速设备 ：  键盘（即可为输入，也可为输出）（一秒几个字节）

		- 中速设备 ：  打印机（几千-几万个字节）

		- 高速设备 ： 寄存器、磁盘（几十兆，甚至几个G）

	- 按信息交换的单位分类（所有设备最底层都是字节）

		- 块设备（有结构）——很多字符形成扇区

		- 字符设备（无明显结构）——字符流形式，中断

	- 按使用特性

		- 人机交互类外部设备（速度较慢）——显示器、磁盘、鼠标  按照字节或者字符来分类

		- 存储设备：磁带、光盘、硬盘 、扇区（磁盘基本分配单元）

		- 网络通信设备：路由器、网卡、调度解调器
- I/O设备的构成

	- 机械部件

		- 比如键盘鼠标的按键和按钮，用来执行具体的I/O操作

	- 电子部件

		- 即I/O控制器、设备控制器，是CPU与硬件设备之间的桥梁
- I/O控制器主要作用

	- 接收并识别CPU命令

	- 向CPU报告设备状态

	- 数据交换——数据寄存器，缓冲区

	- 地址识别

### 2. I/O控制器

**CPU**是运算器，但有自己的内部设备（寄存器）

- 头图：每个寄存器和IO设备间是一一对应的

- 内存映像I/O：寄存器空间和内存地址统一编址，CPU会支持独立硬件指令![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\3957f033fef69fb9ed899ccda15dd845a35712e6bdee40ac58dcb00530093f13.png)

- I/O控制器的组成

	- CPU与控制器间的接口

	- I/O逻辑——IO控制器的核心

	- 控制器与设备间的接口

- I/O控制方式

	- 1.程序直接控制方式![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\2430c8291d4fbca8c1e57db7cf449cbe6c79df8f6aa025f0838fe1d3dd3b8573.png)
	  - CPU频繁干预：CPU通过地址线告诉设备，通过控制线告诉指令
	
	  - 每次读/写一个字
	
	  - 读：设备->CPU->内存   找对应的IO设备进行读
	
	  - 程序直接控制：实现简单，读/写后轮询状态寄存器；CPU和IO设备串行，忙等。
	
	  - CPU会不断检查状态寄存器状态（轮询——全是资源的浪费）
	
	  - IO逻辑把设备送来的数据送入数据寄存器，随后CPU从数据寄存器读数据
	
	  - 优点：实现起来简单，前后会进行两次干预
	
	  - 缺点： 1. 始终处于忙等状态，频繁干预
	
	  - ​             2. 每次读写一个字，CPU和IO串行
	
	- 2.中断驱动方式——持久化进数据库![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\c7bb620b09b83d2e2d23fe0e5445c6bc4b62ea62f2b2f6025d827f1bb3950360.png)
	  - CPU将此**IO进程**（当前应用程序的进程）阻塞，甚至**中断**（保存现场，恢复现场环境）

	  - IO前后CPU干预

	  - 每次读/写一个字（4或8字节）

	  - 读：设备->CPU->内存

	  - 中断驱动：CPU和IO设备可以并行，频繁中断耗时

	  - 写时无需操作数据寄存器，CPU在开始和结束时，都有中断信号，整个IO模块结束后都会检查一下状态寄存器——不再轮询了

	  - 优缺点：不再忙等，大大提高了CPU利用率，并行，可能会发生频繁中断（耗时严重）
	
	- 3.DMA方式：CPU寄存器的空间也较小![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\d7ddd3f6568595aa55724dcec458780b22584cd0e513b4c205a12e4f85a4af62.png)
	  - MAR：内存地址寄存器：操作内存要由内存地址，通过内存地址把数据刷入内存
	
	  - DC：数据计数器：他一定是块的整数倍，会产生中断来告诉CPU
	
	  - 传输单位是“块”
	
	  - 块之间传输需要CPU干预
	
	  - 设备<->内存
	
	  - 优点：CPU和IO设备可以并行，每个IO指令操作一个块（操作的数据量大，更高校）
	
	  - 缺点：离散块需要频繁中断，DMA指令只能读连续的块
	
	- 4.通道控制方式![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\c892c6c9a7e73ada26233d9bbc313aefb0463427955c0598858a2d12986541ee.png)
		- 通道是专门负责I/O的处理机，有专用指令
		
		- 每次读/写一组数据块
		
		- IO设备<->内存
		
		- 优缺点：CPU和IO设备可以并行，实现复杂，需要硬件支持

### 3. I/O软件层次结构

- 头图![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\434298f5920371f991063330d51d4b4e9c65230e9e85a72003a2b4a8e61ca35e.png)

- 用户层软件

	- 实现用户交互接口

	- 通过库函数实现系统调用

- 设备独立性软件（统筹管理所有IO设备）

	- 向上一层提供调用接口

	- 设备保护

	- 容错处理

	- 设备分配与回收

	- 数据缓冲区管理

	- 逻辑设备与物理设备映射

- 设备驱动程序  让硬件工作，由生产商决定

	- 不同设备硬件特性不同，但CPU指令相同

	- 负责控制硬件设备，将CPU指令转成设备操作

	- 驱动程序会以独立进程的形式存在

- 中断处理程序

	- IO完成后发出中断信号

	- 执行中断处理程序

	- 会直接操作硬件

- 硬件

- 操作系统内核：设备独立性软件、设备驱动软件、中断处理程序

## 5.2 I/O核心子系统

### 1. IO子系统概述：设备独立性软件

- 概念![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\f2b54bed7d2168df3b1b4eecc308ee1d7348a577827045e2908d3d906be5659c.png)

- 设备独立性软件

- 设备驱动软件

- 中断处理程序

- IO调度与设备保护

### 2. SPOOLing技术（假脱机技术）

- 脱机

- ![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\367d559ad1c76922fa382a14885f184c10011f3d19cf1a6da83ea4ccfb7070e4.png)

- ![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\1781569d2889120a5f3509bfd7cf10de7e8100d4aaf17827931787902f530c38.png)

- 输入井和输出井

- 输入进程和输出进程：模拟外围机

- 输入缓冲区和输出缓冲区

- 注意：输入设备较慢，但是磁盘较快

### 3. 设备分配与回收

- 设备分配应考虑的因素：固有属性，分配算法，安全性

- 静态分配与动态分配：进程运行前分配所有资源，还是运行中动态申请资源

- 设备管理中的数据结构：![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\4494361c15f8081717388d50d530ecad15a943ffe3543f18fab13eac6461a343.png)

- 设备分配步骤

	- 普通步骤![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\fe54eca015277caf7e696f5b13171d7e456d99a3b7c898690f08dcb13541c866.png)

		- 根据物理设备名查SDT

		- 查DCT，尝试分配给进程

		- 查COCT，尝试分配给进程

		- 查CHCT，尝试分配给进程

	- 步骤改进![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\fe54eca015277caf7e696f5b13171d7e456d99a3b7c898690f08dcb13541c866.png)

		- 根据逻辑设备名查SDT

		- 查DCT，尝试分配给进程

		- 查COCT，尝试分配给进程

		- 查CHCT，尝试分配给进程
		
		- 逻辑设备表记录了逻辑设备名与物理设备名的映射关系

### 4.缓冲区管理

- 概念![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\1765d3ac99a666124771ebf29afaf15834015f1d569f7880a5d67c6fdaa84955.png)

- ![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\61d80eabf223f67c82998e4102c401c06b9ac260b6750769bf690127b69b6c11.png)
	- 为缓解CPU和I/O设备间速度不匹配的矛盾而建立的临时存储区域
	
- 目的

	- 缓和CPU和I/O设备速度不匹配的矛盾

	- 减少CPU中断的频率，放宽对CPU响应时间的限制

	- 解决数据粒度不匹配的问题

	- 提高CPU与I/O设备的并行性

- 分类

	- 单缓冲![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\48293ca0e91901927f9f44216cac31170e1772294ea8d33569e40d4bdf31eb8e.png)

	  - 非空不写

	  - 未满不读

	  - （工作区满、缓冲区空）处理一块数据耗时MAX（T,C）+M

	- 双缓冲(工作区空，缓冲区空)，处理一块数据耗时  MAX(T,C+M)![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\67b1437a331bb21fe0332b9e0879b70894cb3425c852ed3ad6e3598949af005e.png)

	- 循环缓冲

	- ![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\07284bb5785d94f617c6feae00d4f5b2db7989a667211147988883c49452e3bd.png)

	- 缓冲池

		- 空缓冲队列
	
		- 满输入缓冲队列
	
		- 满输出缓冲队列
		
		- ![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\4d46b5ddfcd0ebc88fcd85ab7e55206417155da1a635069f6e5f8b22bfe554d7.png)
		
		- ![](D:\A-For-Study\MCA-Architect\架构师前置知识\计算机操作系统\第五章 输入输出管理\4b946acd064511b8ea8597df7002170cf81ef297b8ce03ec2370161f1c39dcaa.png)

