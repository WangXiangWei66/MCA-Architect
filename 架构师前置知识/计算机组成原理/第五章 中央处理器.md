# 第五章 中央处理器

## 5.1 CPU的功能和基本结构

### 1. CPU的功能

- 1.指令控制

	- 取指令、分析指令和执行指令

	- 程序的顺序控制

- 2.操作控制

	- 管理并产生由内存取出指令的操作信号

	- 把各种操作信号送往相应的部件

	- 从而控制部件按照指令的要求进行动作

- 3.时间控制

	- 对各种操作加以时间上的控制

- 4.数据加工

	- 对数据进行算数和逻辑运算

- 5.中断处理

	- 处理异常和特殊请求

### 2. CPU的基本结构

- 运算器

	- 主要功能

		- 接收从控制器送来的命令并执行相应动作

		- 对数据加工和处理

	- 包含组件

		- 1.算术逻辑单元

			- 进行算数、逻辑运算

		- 2.暂存寄存器

			- 暂存从主存读来的数据，对程序员透明

		- 3.累加寄存器

			- 是一个通用寄存器，用于暂存ALU运算的结果信息

			- 可以作为加法运算的一个输入端

		- 4.通用寄存器

			- 用于存放操作数：源操作数，目的操作数及中间结果，各种地址信息，包括堆栈指针

		- 5.程序状态字寄存器

			- PSW：保留由算数逻辑运算指令或测试指令的结果而建立的各种状态信息

			- 溢出标志（OF）、符号标志（SF）、零标志（ZF）、进位标志（CF）

		- 6.移位器

			- 对操作数或运算结果进行移位运算

		- 7.计数器

			- 控制乘除运算的操作步数

- 控制器

	- 主要作用

		- 整个系统的指挥中枢，根据指令要求指挥全机协调工作

		- 基本功能是执行指令，由控制器发出微操作实现

		- 硬布线控制器

		- 微程序控制器

	- 1.程序计数器

		- PC，指出下一条指令在主存中的存放地址

		- 因程序通常是顺序执行的，PC有自增功能

		- CPU根据PC内容取主存取指令

	- 2.指令寄存器

		- IR，用于保存当前正在执行的那条指令

	- 3.指令译码器

		- 仅对操作码字段进行译码，向控制器提供特定操作信号

	- 4.存储器地址寄存器

		- MAR，存放要访问的主存单元的地址

	- 5.存储器数据寄存器

		- MDR，存放向主存写入的信息或从主存读出的信息

	- 6.时序系统

		- 用于产生各种时序信号

		- 由统一时钟CLOCK分频得到

	- 7.微操作信号发生器

		- 根据IR、PSW及时许信号，产生控制整个计算机系统所需的各种控制信号

		- 组合逻辑型结构

		- 存储逻辑型结构

- 寄存器

	- 1.指令寄存器：IR

	- 2.程序计数器：PC

	- 3.累加寄存器：ACC/AC

		- 暂存寄存器：Y、Z

		- 通用寄存器：GPR/GR

	- 4.程序状态（字）寄存器：PSR/PSW

	- 5.地址寄存器：MAR

	- 6.数据缓冲寄存器：MDR（或MBR）

- 数据的传送

	- 1.寄存器之间

		- 通过CPU内部总线完成

		- 把PC送至MAR

			- PC->Bus

				- PCout有效，PC内容送总线

			- Bus->MAR

				- MARin有效，总线内容送MAR

	- 2.主存与CPU之间

		- 借助CPU内部总线完成

		- CPU从主存读指令

			- PC->Bus->MAR

				- PCout和MARin有效，现行指令->MAR

			- 1->R

				- CU发读命令

			- MEM（MAR）->MDR

				- MDRin有效

			- MDR->Bus->IR

				- MDRout和IRin有效，现行指令->IR

	- 3.执行算数或逻辑运算

		- ALU本身没有内部存储功能

		- 执行加法运算，须两个加数在ALU两个输入端同时有效

			- 1.将一个操作数经CPU内部总线送入暂存器Y，Y在ALU左输入端始终有效

			- 2.再将另一个操作数送到ALU右输入端

			- 3.运算结果暂存在暂存器Z中

		- 流程及控制信号

			- Ad(IR)->Bus->MAR

				- MDRout和MARin有效

			- 1->R

				- CU发出读命令

			- MEM->数据线->MDR

				- 操作数从存储器->数据线->MDR

			- MDR->Bus->Y

				- MDRout和Yin有效，操作数->y

			- (ACC)+(Y)->Z

				- ACCout和ALUin有效，CU向ALU发加命令，结果->Z

			- Z->ACC

				- Zout和ACCin有效，结果->ACC

### 3. 数据通路的基本结构

- 1.CPU内部单总线方式

	- 所有寄存器的输入端和输出端都连接到一条公共通路上

	- 一个时钟周期内只允许传一个数据

	- 存在较多冲突，性能较低

- 2.CPU内部三总线方式

	- 寄存器输入端和输出端连接到多条公共通路上

	- 同时在多个总线上传送不同的数据，提高效率

- 3.专用数据通路方式

	- 根据指令执行过程数据和地址的流动方向安排连接线路

	- 避免使用共享总线

	- 性能较高，但硬件量大

## 5.2 指令执行过程

### 1. 指令周期

- 基本概念

	- CPU从主存中取出并执行一条指令的时间

	- 指令周期通常为若干机器周期

	- 一个机器周期又包含若干时钟周期（节拍或T周期）

- 一个完整的指令周期

	- 取指周期

		- 取指令访存

		- 标志触发器：FE

	- 间址周期

		- 取有效地址访存

		- 标志触发器：IND

	- 执行周期

		- 取操作数访存

		- 标志触发器：EX

	- 中断周期

		- 保存程序断电访存

		- 标志触发器：INT

### 2. 指令周期的数据流

- 基本概念

	- 根据指令要求一次访问的数据序列

- 1.取指周期

	- 根据PC内容从主存取指令代码，放到IR中

	- 1.PC->MAR->地址总线->主存

	- 2.CU发出控制信号->控制总线->主存

	- 3.主存->数据总线->MDR->IR

	- 4.CU发出读命令->PC内容加1

- 2.间址周期

	- 取操作数有效地址，将地址码送到MAR并送到地址总线，此后CU向存储器发读命令，获取有效地址存至MDR

	- 1.Ad(IR)（或MDR）->MAR->地址总线->主存

	- 2.CU发出读命令->控制总线->主存

	- 3.主存->数据总线->MDR（存放有效地址）

	- （其中，Ad(IR)表示取出IR中存放的指令字的地址字段）

- 3.执行周期

	- 根据IR的指令字的操作码和操作数通过ALU操作，产生并执行结果

	- 不同指令的执行周期操作不同，没有统一的数据流向

- 4.中断周期

	- 处理中断请求，保存断点

	- 假设程序断点存入堆栈中，并用SP指示栈顶地址，进栈操作先修改栈顶指针，后存入数据

	- 1.CU控制将SP减1，SP->MAR->地址总线->主存

	- 2.CU发出写命令->控制总线->主存

	- 3.PC->MDR->数据总线->主存（程序断点存入主存）

	- 4.CU（中断服务程序的入口地址）->PC

### 3. 指令执行方案

- 单指令周期

	- 对所有指令选用相同执行时间来完成

	- 每条指令都在固定时钟周期内完成

	- 指令之间串行执行

	- 指令周期取决于执行时间最长的指令执行时间

	- 短耗时指令也花费相同时间，降低系统运行速度

- 多指令周期

	- 对不同类型指令选用不同执行步骤

	- 指令之间串行，但可选用不同时钟周期来完成

	- 不要求所有指令占用相同执行时间

- 流水线方案

	- 指令执行可以并行

	- 追求每个时钟脉冲周期完成一条指令的执行过程（理想状态）

	- 在每个时钟周期启动一条指令，尽量让多条指令同时执行，各自处在不行的执行步骤中

	- 指令流水线

		- 是一种并行处理技术

		- 把重复过程分解为若干子过程

			- 取指

			- 分析

			- 执行

		- 每个子过程与其他子过程并行

			- 顺序执行方式

			- 一次重叠执行方式

			- 二次重叠执行方式

	- 表示方法：时空图

		- 横坐标表示时间，即输入流水线的各个任务所需时间

		- 纵坐标表示空间，对应各个执行部件

	- 特点

		- 把一个任务分解为几个有联系的子任务，每个子任务由专门部件执行，并行缩短执行总时间

		- 每个功能段部件后有缓冲寄存器/锁存器，保存本流水段的结果，供下一流水段使用

		- 各功能段时间应尽量相等，否则将堵塞、断流

		- 流水线中必须是连续不断的同一种任务

		- 需要有装入时间和排空时间

## 5.3 数据通路的功能和基本结构

### 1. 数据通路的功能

- 数据在功能部件之间传送的路径即数据通路

- 实现CPU内部运算器与寄存器、寄存器与寄存器之间的数据交换

- 路径上的部件即数据通路部件

	- ALU

	- 通用寄存器

	- 状态寄存器

	- 异常和和中断处理逻辑

### 2. 数据通路的基本结构

- 1.CPU内部单总线方式

	- 所有寄存器的输入端和输出端都连接到一条公共通路上

	- 一个时钟周期内只允许传一个数据

	- 存在较多冲突，性能较低

- 2.CPU内部三总线方式

	- 寄存器输入端和输出端连接到多条公共通路上

	- 同时在多个总线上传送不同的数据，提高效率

- 3.专用数据通路方式

	- 根据指令执行过程数据和地址的流动方向安排连接线路

	- 避免使用共享总线

	- 性能较高，但硬件量大

### 3.数据的传送

- 1.寄存器之间

	- 通过CPU内部总线完成

	- 把PC送至MAR

		- PC->Bus

			- PCout有效，PC内容送总线

		- Bus->MAR

			- MARin有效，总线内容送MAR

- 2.主存与CPU之间

	- 借助CPU内部总线完成

	- CPU从主存读指令

		- PC->Bus->MAR

			- PCout和MARin有效，现行指令->MAR

		- 1->R

			- CU发读命令

		- MEM（MAR）->MDR

			- MDRin有效

		- MDR->Bus->IR

			- MDRout和IRin有效，现行指令->IR

- 3.执行算数或逻辑运算

	- ALU本身没有内部存储功能

	- 执行加法运算，须两个加数在ALU两个输入端同时有效

		- 1.将一个操作数经CPU内部总线送入暂存器Y，Y在ALU左输入端始终有效

		- 2.再将另一个操作数送到ALU右输入端

		- 3.运算结果暂存在暂存器Z中

	- 流程及控制信号

		- Ad(IR)->Bus->MAR

			- MDRout和MARin有效

		- 1->R

			- CU发出读命令

		- MEM->数据线->MDR

			- 操作数从存储器->数据线->MDR

		- MDR->Bus->Y

			- MDRout和Yin有效，操作数->y

		- (ACC)+(Y)->Z

			- ACCout和ALUin有效，CU向ALU发加命令，结果->Z

		- Z->ACC

			- Zout和ACCin有效，结果->ACC

## 5.4 控制器的功能和工作原理

### 1. 控制器的结构和功能

- 控制器与其它部件及总线连接关系

	- 1.运算器部件通过数据总线与内存储器、输入输出设备传送数据

	- 2.IO设备通过接口电路与总线相连

	- 3.内存储器、IO设备从地址总线接收地址信息，从控制总线得到控制信号，通过数据总线与其它部件传送数据

	- 4.控制器部件从数据总线接受指令信息，从运算器接收指令转移地址，送出指令地址到地址总线，还要向系统部件提供其所需控制信号

- 主要功能

	- 1.从主存取指令，并指出下一条指令在主存位置

	- 2.对指令进行译码或测试，产生相应控制信号

	- 3.指挥并控制CPU、主存、IO设备之间的数据流向

### 2. 硬布线控制器

- 基本原理

	- 根据指令要求，当前时许及内外部状态

	- 按时间顺序发送一系列微操作控制信号

	- 由复杂的组合逻辑门电路和一些触发器构成

- 单元图

	- 指令操作码是决定控制单元发出不同操作命令的关键

	- 将指令操作码译码和节拍发生器从CU分离

	- CU输入信号来源

		- 1.经指令译码器译码产生的指令信息

		- 2.时序系统产生的机器周期信号和节拍信号

		- 3.来自执行单元的反馈信息，即标志

- 时序系统及微操作

	- 1.时钟周期

		- 用时钟信号控制节拍发生器，可以产生节拍

		- 每个节拍对应一个时钟周期

		- 每个节拍内完成多个同时执行的操作

	- 2.机器周期

		- 所有指令执行的一个基准时间

		- 访存时间通常是固定的，因此，通常以此为基准

		- 内存读取一个指令字的最短时间作为机器周期

		- 当存储字长=指令字长，取指周期亦即机器周期

		- 一个机器周期可以完成若干微操作

	- 3.指令周期

	- 4.微操作命令分析

		- 取指周期的微操作命令

		- 间址周期的为操作命令

		- 执行周期的微操作命令

			- a.非访存指令

			- b.访存指令

			- c.转移指令

- CU控制方式

	- 同步控制

	- 异步控制

	- 联合控制

- 设计步骤

	- 1.列出微操作命令的操作时间表

	- 2.进行微操作信号综合

	- 3.画出微操作命令逻辑图

- 优缺点

	- 速度由电路延迟决定，速度快

	- 设计中追求最少元件和最高速度，设计完成后，难以添加新功能

### 3. 微程序控制器

- 基本概念

	- 把微操作信号代码化，使每条机器指令转换为一段微程序

	- 把微程序存入专门的存储器中

	- 微操作控制信号由微指令产生

- 基本术语

	- 1.微命令与微操作

	- 2.微指令与微周期

	- 3.主存储器与控制存储器

	- 4.程序与微程序

- 微程序控制器组成和工作过程

	- 组成

		- 控制存储器

		- 微指令寄存器

		- 微地址形成部件

		- 微地址寄存器

	- 工作过程

		- 1.执行取微指令公共操作

		- 2.由机器指令的操作码通过微地址形成部件，产生对应的微程序入口地址，送入CMAR

		- 3.从CM中逐条取出对应的微指令并执行

		- 4.执行完微程序后，又回到取指微程序的入口地址，继续第一步

	- 微程序和机器指令

		- 一条机器指令对应一个微程序

- 微指令的编码方式

	- 1.直接编码

	- 2.字段直接编码

- 微指令地址形成方式

	- 1.直接由微指令的下地址字段指出

	- 2.根据机器指令的操作码形成

- 微指令的格式

	- 水平型微指令

	- 垂直型微指令

	- 混合型微指令

- 微程序控制单元的设计步骤

	- 1.写出对应机器指令的微操作命令及节拍

	- 2.确定微指令格式

	- 3.编写微指令码点

- 动态微程序设计和毫微程序设计

	- 动态微程序设计

	- 毫微程序设计

- 优缺点

	- 同组合逻辑控制器相比，具有规整性、灵活性、可维护性

	- 由于采用存储程序原理，每条指令都有从控制器存储器中取一次，影响速度

## 5.5 指令流水线

### 1. 基本概念

- 指令流水线

	- 是一种并行处理技术

	- 把重复过程分解为若干子过程

		- 取指

		- 分析

		- 执行

	- 每个子过程与其他子过程并行

		- 顺序执行方式

		- 一次重叠执行方式

		- 二次重叠执行方式

- 表示方法

	- 时空图

		- 横坐标表示时间，即输入流水线的各个任务所需时间

		- 纵坐标表示空间，对应各个执行部件

- 特点

	- 把一个任务分解为几个有联系的子任务，每个子任务由专门部件执行，并行缩短执行总时间

	- 每个功能段部件后有缓冲寄存器/锁存器，保存本流水段的结果，供下一流水段使用

	- 各功能段时间应尽量相等，否则将堵塞、断流

	- 流水线中必须是连续不断的同一种任务

	- 需要有装入时间和排空时间

### 2. 流水线的分类

- 部件功能级流水线

- 处理机级流水线

- 处理机间流水线

- 单功能和多功能流水线

- 动态和静态流水线

- 线性和非线性流水线

### 3. 影响流水线的因素

- 数据冲突、数据冒险

- 控制冲突、控制冒险

### 4. 流水线的性能指标

- 吞吐率

- 加速比

- 效率

### 5. 超标量流水线的基本概念

- 超标量流水线技术

- 超流水线技术

- 超长指令字

