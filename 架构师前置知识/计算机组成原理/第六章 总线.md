# 第六章 总线

## 6.1 总线概述

### 1. 总线的基本概念

- 是一组能为多个部件分时共享信息的公共传送线路

- 分时

	- 同一时刻只允许有一个部件向总线发送信息

	- 多个部件分别在不同的时段向总线发送信息

- 共享

	- 总线上可以挂接多个部件，各部件都可以通过这组线路交换信息

- 总线特性

	- 机械特性

		- 尺寸/形状

	- 电气特性

		- 传输方向和有效的电平范围

	- 功能特性

		- 每根传输线的功能

	- 时间特性

		- 信号和时序的关系

- 猝发传送

	- 在一个总线周期内传输存储地址连续的多个数据字的总线传输方式

### 2. 总线的分类

- 按物理位置分

	- 内部总线

		- 片内总线

			- 芯片内部的总线

			- 寄存器之间，寄存器与ALU之间的连接线

		- 板内总线

			- 功能模块板内总线

			- 电路板上各集成电路芯片之间的互联

		- 板间总线

			- 各功能模块（CPU/主存/IO接口适配器等）之间连接的总线

			- 这些总线把各功能模块连在一起，构成了主机系统，所以也叫系统总线

	- 外部总线

		- 主机系统之间，或与外部设备的互连

		- 设备总线

			- 主机与外设互连的总线

			- SCSI接口

				- 硬盘/光驱/打印机/扫描仪

			- USB接口

- 按传输内容分

	- 信号线：连接各个功能模块

		- 根据传输信号的含义，被分成数据、地址和控制等功能组，即数据总线、地址总线和控制总线

	- 数据总线

		- 传输数据信息

		- 双向总线

		- 位数与机器字长、存储字长有关

	- 地址总线

		- 指出数据所在的主存单元或IO端口的地址

		- 单向总线

		- 位数与主存地址空间大小有关

	- 控制总线

		- 传输控制信息

		- CPU送出的控制命令、主存或外设返回给CPU的反馈信号

- 按时序控制方式

	- 同步总线

	- 异步总线

- 按数据传输格式

	- 并行总线

	- 串行总线

### 3. 总线的组成和结构

- 逻辑构成

	- 信号线

		- 连接各个功能模块

		- 根据传输信号的含义，被分成数据、地址和控制等功能组，即数据总线、地址总线和控制总线

	- 总线控制器

		- 起到管理总线的作用

		- 1.总线系统的资源分配与管理

			- 分配中断向量号

			- 分配DMA通道号

			- 分配IO端口地址

		- 2.提供总线定时信号脉冲

		- 3.负责总线使用权的仲裁

			- 确定哪个模块位当前总线的控制者

			- 总线设备

				- 即总线上连接的设备

				- 主设备

					- 获得总线控制权的设备，即可以对总线进行控制

				- 从设备

					- 被主设备访问的设备，只能响应主设备经过总线发来的命令

		- 4.负责实现不同总线协议的转换和不同总线之间传输数据的缓冲

- 单总线结构

	- 将CPU、主存、IO设备（IO接口）都挂在一组总线上，允许这些设备之间直接交换信息

	- 单总线并非只有一根信号线，仍然分为地址、数据、控制总线

	- 结构简单、成本低，易于接入新设备

	- 带宽低、负载重，不支持并发传送

- 双总线结构

	- 一条主存总线，用于CPU、主存与通道之间传送数据

	- 一条IO总线，用于多个外部设备与通道之间传送数据

	- 实现了低速IO设备与存储器分离

	- 需要增加通道等硬件设备

- 三总线结构

	- 各部件之间采用三条各自独立的总线构成信息通路

	- 主存总线

		- CPU和主存之间传送地址、数据和控制信息

	- IO总线

		- 在CPU和各类外设之间通信

	- 直接内存访问（DMA）总线

		- 内存和外设之间直接传送数据

	- 提高IO设备性能和系统吞吐量

	- 系统工作效率较低

### 4.总线的性能指标

- 总线传输周期

	- 简称总线周期，一次总线操作所需的时间

	- 申请阶段/寻址阶段/传输阶段/结束阶段

- 总线工作频率

	- 总线周期的倒数，一秒内传送数数据的次数

- 总线时钟周期

	- 即机器的时钟周期

- 总线时钟频率

	- 即机器的时钟频率

- 总线宽度

	- 又叫总线位宽，总线能同时传送数据的位数

	- 32根线即32位总线

- 总线带宽

	- 总线的数据传输率，单位时间内总线上可传输数据的位数，单位字节/秒（B/s）

	- 总线带宽=总线工作频率*（总线宽度/8）

- 总线复用

	- 同一种信号线在不同时间传输不同信息

	- 实现用较少的线传输更多的信息，节约成本

- 信号线数

	- 地址/数据/控制三种总线的“总线数”之和

### 5.总线标准

- 1. ISA/EISA

	- 最早期的系统总线标准

- 2. VESA/AGP/PCI/PCI-Express

	- 多媒体设备总线标准

- 3. RS-232C/USB/PCMCIA

	- 串行通信外设总线标准

- 4. IDE&ATA/SATA

	- 磁盘驱动器/硬盘接口标准

- 5. SCSI

	- 智能设备通用接口标准

## 6.2 总线传输周期

### 基本概念

- 简称总线周期，一次总线操作所需的时间

- 四个阶段

	- 申请阶段

		- 总线仲裁阶段，主设备提出申请，并经由仲裁电路授权使用总线的过程

	- 寻址阶段

		- 地址、命令阶段，主设备往总线上发地址信号和命令信号

	- 传输阶段

		- 数据传输阶段，主从设备进行数据交换，可能单向（写）或双向（读）

	- 结束阶段

		- 撤销状态阶段，主从设备撤销总线上的信号，让出总线使用权

### 2.总线仲裁

- 基本概念

	- 前提

		- 同一时刻，总线只允许一个功能模块成为主控设备，

		- 为了避免多模块争用总线，必须要有总线仲裁电路

	- 当有多个连接到总线上的功能模块请求使用总线时，总线仲裁电路选出优先级最高的那个，赋予总线控制权

- 仲裁方法

	- 集中仲裁

		- 基本概念

			- 设置一个仲裁电路，

			- 集中处理使用总线的请求信号，

			- 比较它们的优先级，确定主控设备

			- 优缺点

				- 系统模块化程度高，设备电路设计比较简单

				- 系统可靠性不高，一旦仲裁电路发生故障，总线无法使用

		- 并行仲裁（独立请求方式）

			- 信号线特点

				- 总线请求信号线（BR）

					- 设备独立总线

				- 总线允许信号线（BG）

					- 设备独立总线

				- 地址线和数据线

					- 所有设备共享

			- 步骤

				- 1.设备经请求线BR发请求信号

				- 2.请求信号在总线控制器排队

				- 3.总线控制器决定主控设备

				- 4.总线控制器经允许线BG进行响应

				- 5.总线设备获得总线使用权，经地址线/数据线传送信息

		- 串行仲裁（链式查询方式）

			- 信号线特点

				- 总线请求信号线（BR）

					- 设备共享总线

				- 总线允许信号线（BG）

					- 设备共享总线

				- 总线忙信号线

					- 设备共享总线

					- 获得控制权的设备发出/撤销忙信号

					- 只有在总线忙信号无效时，才能申请使用总线

				- 地址线和数据线

					- 所有设备共享

			- 步骤

				- 1.设备经共享请求线BR发请求信号

				- 2.请求信号在总线控制器排队

				- 3.总线控制器决定主控设备（距离远近，近大远小）

				- 4.总线控制器经允许线BG进行应答

				- 5.距离最近的总线设备决定获得总线使用权，或者把应答信号逐级传递给下一级设备

	- 分布式仲裁

		- 基本概念

			- 不存在集中进行优先级比较的仲裁电路，

			- 优先级比较分布在各个总线设备（仲裁号和仲裁器）中，

			- 各总线设备仲裁器比较彼此的仲裁号，确定自己的优先级，即总线控制权

		- 步骤

			- 1.总线设备仲裁器将自己的仲裁号（优先级）发送到公共总线上，

			- 2.仲裁器将总线上得到的仲裁号与自己的进行比较，确定优先级大小，

			- 3.若自己的优先级小，则撤销自己的仲裁号，

			- 4.最后留在总线上的即最高优先级

		- 优缺点

			- 系统可靠性较高，单独的总线设备发生故障，不影响其它总线设备正常工作

			- 系统模块化程度低，设备电路设计比较复杂

### 3.总线操作和定时

- 总线定时方法

	- 为了协调总线上发生的事件（操作），让这些事件保持正确的时序，需要总线定时方法

- 1. 同步定时方式

	- 基本概念

		- 也叫同步总线，所有总线事件都与一个时钟脉冲序列（时钟周期）同步（对齐），

		- 时钟周期定义了一个最基本的总线操作的时间单位（总线时段），一个总线周期包括多个时段

		- 总线信号会在一个脉冲的前沿开始变化，并且大多数总线事件都能在一个总线时段内完成

	- 总线结构

		- 时钟信号线

			- 负责传送一个固定频率的方波信号——时钟脉冲信号

		- 状态信号线

			- 总线忙状态

		- 地址信号线

			- 地址总线

		- 地址有效信号线

			- 描述地址总线的状态

		- 读/写信号线

			- 可能是一条，也可能是两条物理线路

		- 数据总线

			- 传送待写入和已读出的数据

	- 读写时序图

		- T1时段

			- 处理机（当前的总线主控设备）放状态（总线忙）到状态信号线

			- 处理机放地址到地址信号线

			- 发地址有效信号到地址有效信号线

		- T2时段

			- 设备根据地址有效信号，获取地址总线信息并译码

			- 读操作

				- 处理机发出读有效信号到读信号线

			- 写操作

				- 处理机放数据到数据总线

				- 处理机发出写有效信号到写信号线

		- T3时段

			- 读操作

				- 设备（主存）根据地址译码和读命令读出数据，并放到数据总线上

			- 写操作

				- 设备（主存）根据地址译码和写命令写入数据

- 2. 异步定时方式

	- 基本概念

		- 也叫异步总线，不需要对齐时钟脉冲，上一个总线事件是否发生，依赖于前一个事件的执行情况

	- 总线结构

		- 状态信号线

			- 总线忙状态

		- 地址信号线

			- 地址总线

		- 读/写信号线

			- 可能是一条，也可能是两条物理线路

		- 应答（或确认）信号线

		- 数据总线

			- 传送待写入和已读出的数据

	- 读写时序图

		- 第一步

			- 处理机（当前的总线主控设备）放状态（总线忙）到状态信号线

			- 处理机放地址到地址信号线

		- 第二步

			- 读操作

				- 处理机发出读有效信号到读信号线

				- 此信号代表已经送出了有效的地址和控制信号

			- 写操作

				- 处理机放数据到数据总线

				- 处理机发出写有效信号到写信号线

		- 第三步

			- 读操作

				- 设备（主存）根据地址译码和读命令读出数据，并放到数据总线上

				- 设备（主存）通过应答信号线向处理机发送应答信号，表示数据已有效、可用

			- 写操作

				- 设备（主存）根据地址译码和写命令写入数据

				- 设备（主存）通过应答信号线向处理机发送应答信号，表示数据已完成写入

		- 第四步

			- 读操作

				- 处理机从数据总线读取数据，将读信号撤销

				- 设备（主存）发现读信号无效，撤销应答信号，使存储器数据线与数据总线隔离（通过三态门）

				- 处理机发现应答信号无效，撤销地址和状态信号

			- 写操作

				- 处理机将写信号撤销

				- 设备（主存）发现写信号无效，撤销应答信号，使存储器数据线与数据总线隔离（通过三态门）

				- 处理机发现应答信号无效，撤销地址和状态信号

- 优缺点

	- 同步

		- 传送速度快，效率高

		- 模块和控制电路的实现和测试比较简单

		- 操作定时不够灵活，设备受固定的时钟频率的约束，所有设备只能在同一速率下运行，高速设备发挥不了性能优势

		- 不能及时对数据通信的有效性进行检验，可靠性差

	- 异步

		- 各种设备（快慢、新旧）都很容易连接到总线上

		- 总线周期长度可变，速度相差很大的设备之间可以进行可靠传输

		- 控制电路实现复杂，代价高

		- 数据发送和接收主从设备交互太多，效率低

		- 互锁模式

			- 不互锁

				- 主备请求后，不必等应答，经过一段时间撤销请求信号

				- 从备接收请求后，发出应答，经过一段时间撤销应答信号，不用等主备撤销请求

				- 我不等你，你也不用等我

			- 半互锁

				- 主备请求后，必须等应答，才能撤销请求信号

				- 从备接收请求后，发出应答，经过一段时间撤销应答信号，不用等主备撤销请求

				- 我等你，但你不用等我

			- 全互锁

				- 主备请求后，必须等应答，才能撤销请求信号

				- 从备接收请求后，发出应答，必须等主备撤销请求，才能撤销应答信号

				- 我等你，你也得等我

