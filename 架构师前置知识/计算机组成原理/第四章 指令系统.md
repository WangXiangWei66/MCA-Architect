# 第四章 指令系统

## 4.1 指令格式

### 基本概念

指令又称机器指令，指示计算机执行某种操作的命令，指令是机器语言的语句，是一组有意义的二进制代码，计算机运行的最小功能单位

## 指令的结构

- 操作码：指出指令该执行什么操作，具有什么功能
- 地址码：给出被操作的信息（指令或数据）的地址
- 指令字长：一条指令包含的二进制代码的位数，与机器字长无关，可能等于、大于、小于机器字长
  指令字长>机器字长，一般是机器字长的两倍，都是单字节的比特位

  ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/4858c3e55bf345b2a90292963969a9da.png)

常见的操作：数据传送、算数/逻辑/移位运算，转移操作（程序转移)、输入输出操作

常见的地址：操作数地址，运算结果地址，程序转移地址，子程序入口地址

哈夫曼树：每个路径都是一个哈夫曼编码

### 地址码的个数

- 零地址：不需要操作数

  - 空操作指令
  - 停机指令
  - 关中断指令
  - 用作堆栈计算机中

    - 参与运算的操作数隐含地从栈顶和次栈顶弹出
    - 运算后再次压栈
- 一地址

  - 给出一个操作码，一个地址
  - 只有目的操作数的单操作数指令

    - 单：OP(A1) -> A1
    - 按A1地址读取操作数
    - 操作后，存回原地址
    - 如操作码：加1，减1，求反，求补等
  - 隐含约定目的地址双操作数指令

    - 双：(ACC)OP(A1) -> ACC
    - 按指令地址A1可读取源操作数
    - 隐含约定另一个操作数由ACC（累加器）提供
    - 运算结果放回ACC中
- 二地址

  - 给出操作码和两个地址，即两个操作数
  - (A1)OP(A1) -> A1
  - 目的操作数A1

    - 还会保存本地运算结果
  - 源操作数A2
- 三地址

  - 给出操作码，目的操作数、源操作数和结果地址
  - 目的操作数A1
  - 源操作数A2
  - 结果地址A3
  - 访存四次

    - 取指令1次
    - 取两个操作数2次
    - 存结果1次
- 四地址

  - （A1）OP（A2） - > A3
  - 给出操作码，源，目的，结果地址，下一条指令址

OP:操作码

A：地址

ACC：默认累加器（专用寄存器）

A1：目的操作数

A2：源操作数

寄存器、缓存、主存——存储结构（磁盘、网卡）

### 定长操作码与扩展操作码

- 定长操作码

  - 指令字最高位分配固定长度表示操作码
  - n位操作码则能表示2^n条指令
- 扩展操作码的设计

  - 也叫变长操作码，操作码位数可变
  - 不允许短码是长码的前缀
  - 各指令操作码一定不能重复
  - 使用频率高的指令分配短码，使用频率低的分配长码

## 4.2 指令寻址

### 基本概念

- 寻址方式

  - 寻找指令或操作数有效地址的方式
  - 即确定本条指令的数据地址及下一跳待执行指令的地址的方法
- 指令寻址

  - 寻找下一条将要执行的指令地址
- 数据寻址

  - 寻找操作数的地址
- 形式地址

  - 指令中的地址码不是操作数真实地址，这种地址叫形式地址A
- 有效地址

  - 形式地址结合寻址方式，计算出操作数的真实地址，即有效地址EA

### 指令寻址

- 顺序寻址

  - 通过程序计数器PC加1（1个指令字长），自动形成下一条指令的地址
- 跳跃寻址

  - 通过转移类指令实现
  - 下条指令地址码不是由PC给出，而是由本条指令给计算方式
  - 是否跳跃受到寄存器和操作数的控制
  - 跳跃到的地址分为绝对地址和相对地址
  - 跳跃的结果是当前指令修改PC值，下条指令仍然通过PC给出

### 数据寻址

- 在指令中设置“寻址特征”字段，指明属于哪种寻址方式
- 寻址特征

  - 隐含寻址

    - 不直接给出操作数地址
    - 单地址指令

      - 直接给出第一个操作数地址
      - 不给出第二个操作数，默认位累加器ACC
    - 优缺点

      - 有利于缩短指令字长
      - 需增加存储操作数或隐含地址的硬件
  - 立即(数)寻址

    - 地址字段不是操作数地址，而是操作数本身
    - 数据采用补码形式
    - 寻址特征用#表示立即寻址
    - 优缺点

      - 指令执行阶段不需要访存，执行时间最短
      - 立即数A的位数限制了范围

        ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/ea59bd735c2f4d189ba6cc079f539b58.png)
  - 直接寻址

    - 形式地址A是操作数的真实地址EA
    - 优缺点

      - 简单，执行阶段仅需一次访存，不需要计算操作数的地址
      - A的位数决定了该指令操作数的寻址范围，操作数的地址不易修改![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/209649743d314550af27d4db3887c971.png)
  - 间接寻址

    - 形式地址不是真实地址，而是操作数有效地址所在存储单元的地址，即操作数地址的地址
    - 可以是一次间接寻址，也可以是多次

      - 主存字第一位为1时，表示仍不是操作数地址
      - 主存字第一位为0时，表示取出了操作数地址
    - 优缺点

      - 可扩大寻址范围（有效地址EA位数大于A位数）
      - 便于编制程序
      - 要访存多次，访问速度慢

        ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/2900ffb36e0546149d57d9fe2b690125.png)
  - 寄存器寻址

    - 在指令字中直接给出操作数的寄存器编号，EA=Ri
    - 优缺点

      - 指令执行阶段不访存，只访问寄存器，速度快
      - 寄存器价格昂贵，个数有限![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/ce4de272f4724bd6b2d6f2b8966a77be.png)
  - 寄存器间接寻址

    - 寄存器Ri给出操作数主存单元地址，EA=(Ri)
    - 优缺点

      - 比一般间接寻址速度快
      - 但指令执行阶段需要访存（操作数在主存中）

        ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/ba4fcf9fedc04777963202134547c45a.png)
  - 相对寻址

    - 把PC内容加上形式地址A，得到操作数有效地址，即EA=(PC)+A
    - A相对于当前地址的偏移量，可正可负，补码
    - 优缺点

      - 操作数地址不是固定的，随PC变化
      - 操作数地址与指令地址相差一个固定值，便于程序浮动，应用于转移指令

        ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/2100b5d8765345daab86be992d32fa4d.png)
  - 基址寻址

    - 将基址寄存器BR内容加上指令中的形式地址A，得到操作数的有效地址，EA=(BR)+A
    - 基址寄存器可采用专用寄存器，可通用寄存器
    - 基址寄存器面向OS，由OS或系统管理员确定，解决程序逻辑空间与存储器物理空间无关性
    - 基址寄存器内容不变（作为基地址），形式地址可变（作为偏移量）
    - 优缺点

      - 可扩大寻址范围
      - 用户不必考虑自己程序存于主存的哪个区域
      - 有利于多道程序，可用于浮动程序
      - 但偏移量（形式地址A）位数较短

        ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/51bb7e74497a438580936a82103c6f97.png)
  - 变址寻址

    - 有效地址EA等于形式地址A与变址寄存器IX（专用，也可用通用寄存器）之和，即EA=(IX)+A
    - 变址寄存器面向用户，内容可由用户改变（作为偏移量），形式地址（作为基地址）不变
    - 优缺点

      - 可扩大寻址范围
      - 处理数组，可设定A为数组首地址，不断改变变址寄存器IX内容，便可得到数组任一地址，适合编制循环程序
      - 偏移量（变址寄存器）位数足以表示整个存储空间

        ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/b8e95fed07034206be62b8ed9871f024.png)
    - 基址寻址、变址寻址区别

      - 基址

        - 面向系统，主用于为多道程序或数据分配存储空间，所以由OS确定
        - 执行中其值不可变，形式地址A可变
      - 变址

        - 立足于用户，主用于处理数组问题，由用户确定
        - 执行中其值可变，形式地址A不可变
  - 堆栈寻址

    - 堆栈是存储器或专用寄存器组中一块特定的、按后进先出（LIFO）原则管理的存储区
    - 读写地址由特定寄存器给出，该寄存器叫做堆栈指针（SP）

      - 硬堆栈

        - 寄存器堆栈，硬件
        - 成本高，容量小
      - 软堆栈

        - 从主存中划出一段区域做堆栈
    - 堆栈结构计算机，多用无操作数指令，因为操作数地址都隐含使用了SP
    - 读写前后伴有自动完成对SP增量或减量操作

      ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/58551/1941289576098168832/426f3d7d78284dd2ab64182c145038f9.png)

## 4.3 CISC和RISC

### X86汇编指令入门

- 1.相关寄存器

  - 8个32位通用寄存器
  - EAX

    - EAX32bit
    - AX16bit

      - EAX的低两位字节
      - AH

        - AX的高字节
      - AL

        - AX的低字节
    - 累加器(Accumulator)
  - EBX

    - EBX32bit
    - BX16bit

      - EBX的低两位字节
      - BH

        - BX的高字节
      - BL

        - BX的低字节
    - 基地址寄存器(Base Register)
  - ECX

    - ECX32bit
    - CX16bit

      - ECX的低两位字节
      - CH

        - CX的高字节
      - CL

        - CX的低字节
    - 计数寄存器(Count Register)
  - EDX

    - EDX32bit
    - DX16bit

      - EDX的低两位字节
      - DH

        - DX的高字节
      - DL

        - DX的低字节
    - 基地址寄存器(Data Register)
  - ESI

    - 变址寄存器（Index Register）
  - EDI

    - 变址寄存器（Index Register）
  - EBP

    - 堆栈基指针（Base Pointer）
  - ESP

    - 堆栈顶指针（Stack Pointer）
- 2.寻址模式和内存分配

  - 寻址模式
  - 数据类型长度规定
- 3.常用指令

  - 数据传送指令

    - mov指令

      - 将第二个操作数复制到第一个操作数
      - 寄存器到内存，或内存到寄存器
    - push指令

      - 压栈，ESP是栈顶
    - pop指令

      - 弹栈、出栈
  - 算数运算指令

    - add/sub指令

      - add将两个数相加，保存到第一个数中
      - sub将两个数相减，保存到第一个数中
    - inc/dec指令

      - inc自加1，dec自减1
    - imul指令

      - 带符号整数乘法
      - 两个操作数，将二者相乘，保存到第一个数中
      - 三个操作数，第二第三相乘，保存到1中
      - 第一个数必须是寄存器
    - idiv指令

      - 带符号整数除法
      - 只有一个操作数，即除数，被除数在EDX:EAX中
      - 操作结果为商和余数，商->EAX，余数->EDX
  - 逻辑计算指令

    - and/or/xor指令

      - 逻辑与、或、异或，结果放到第一个数中
    - not指令

      - 位翻转，1->0，0->1
    - neg指令

      - 取负
    - shl/shr指令

      - shl逻辑左移
      - shr逻辑右移
      - 第一个数表示被操作数，第二个移位位数
  - 控制流指令

    - 指令指针IP

      - 每执行一条指令，此指针自动指向下一条指令
    - jmp指令

      - 控制IP转移到label所指示的地址
      - 从label中取指令执行
    - jcondition指令

      - 条件转移指令，依据处理及状态字的一系列条件状态转移
    - cmp指令

      - 比较两个操作数的值
      - 根据比较结果设置处理机状态字中的条件码
    - call/ret指令

      - 实现子程序（过程、函数）的调用及返回
      - call将当前执行指令地址入栈，然后无条件转移到由标签指示的指令
      - ret指令实现子程序的返回机制
      - ret指令弹出栈中保存的指令地址，无条件转移到保存的指令地址执行

### 1.CISC复杂指令系统计算机

### 2. 精简指令系统计算机（RISC）

### 3. CISC和RISC的比较
